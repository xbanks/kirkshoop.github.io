<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>await in c++ - a series</title>
    <meta name="description" content="an intersection of C++ and Win32
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://kirkshoop.github.io/async/rxcpp/await/c++/2015/03/12/await-in-c++-a-series.html">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60804833-1', 'auto');
  ga('send', 'pageview');

</script>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="site-title">
      <img src="//www.gravatar.com/avatar/346d7c46fffb46511dfea6faa3e51937?s=48" />
      <a href="/">Fictional Memory</a>
    </div>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">await in c++ - a series</h1>
    <p class="post-meta">Mar 12, 2015</p>
  </header>

  <article class="post-content">
    <p>I have seen a few articles that introduce the <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4134.pdf">await proposal</a> as implemented in <a href="https://www.visualstudio.com/en-us/news/vs2015-vs.aspx">Visual Studio 2015 Preview</a>. In this series I will share my exploration of the await feature by showing how I built <code>async_generator&lt;T&gt;</code> and some algorithms and adaptors I built to use it. To skip the exposition, go straight to the code on <a href="https://github.com/kirkshoop/await">github</a>.</p>

<h3 id="a-look-ahead">A Look Ahead</h3>
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">test</span> <span class="o">=</span> <span class="p">[]()</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">__await</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="nl">rt</span> <span class="p">:</span>
        <span class="c1">// tick every second</span>
        <span class="n">as</span><span class="o">::</span><span class="n">schedule_periodically</span><span class="p">(</span><span class="n">clk</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="n">s</span><span class="p">,</span> 
            <span class="p">[](</span><span class="kt">int64_t</span> <span class="n">tick</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">tick</span><span class="p">;</span> <span class="p">})</span> <span class="o">|</span>
        <span class="c1">// ignore every other tick</span>
        <span class="n">ao</span><span class="o">::</span><span class="n">filter</span><span class="p">([](</span><span class="kt">int64_t</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">})</span> <span class="o">|</span>
        <span class="c1">// stop after 10 ticks</span>
        <span class="n">ao</span><span class="o">::</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// the loop body will be run every other second - 10 times</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">()</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot; - &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rt</span>
            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="c1">// this function will return immediately before any text is printed</span>
<span class="k">auto</span> <span class="n">done</span> <span class="o">=</span> <span class="n">test</span><span class="p">();</span>
<span class="c1">// block until the loop has finished</span>
<span class="n">done</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</code></pre></div>
<p>This looks similar to <a href="https://twitter.com/ericniebler">Eric Niebler&#39;s</a> Range proposal (<a href="https://github.com/ericniebler/range-v3">GitHub</a>, <a href="http://ericniebler.com/">Blog</a>), but these are async ranges. Not only are the types involved different, but also the for loop and the algorithms. Coordinating many Ranges from many threads over time has additional complexity and different algorithms. The <a href="http://reactivex.io/languages.html">ReactiveExtensions</a> family of libraries provide a lot of algorithms useful for async Ranges. The <a href="http://rxmarbles.com/">RxMarbles</a> site has live diagrams for many of the algorithms. <a href="https://github.com/Reactive-Extensions/RxCpp">rxcpp</a> implements some of these algorithms in C++ without await and the series will produce adaptors that allow async Ranges and rxcpp Observables to be interchanged.</p>

<h3 id="types-in-time">Types in Time</h3>

<p>Time is what the await proposal introduces into the C++ language.
This is a table of types that represent each combination of values and time.</p>

<table><thead>
<tr>
<th></th>
<th>Value</th>
<th>Sequence</th>
</tr>
</thead><tbody>
<tr>
<td>past</td>
<td><code>T</code></td>
<td><code>vector&lt;T&gt;</code></td>
</tr>
<tr>
<td>lazy</td>
<td><code>[]() -&gt; T { . . . }</code></td>
<td><code>generator&lt;T&gt;</code></td>
</tr>
<tr>
<td>later</td>
<td><code>future&lt;T&gt;</code></td>
<td><code>async_generator&lt;T&gt;</code></td>
</tr>
</tbody></table>

<ul>
<li>past - A value has already been produced before the caller asks for it.</li>
<li>lazy -  A value is produced when asked for by a caller.</li>
<li>later - When a value is produced the caller is resumed.</li>
</ul>

<p>The three that I will explore in the context of await are <code>future&lt;T&gt;</code>, <code>generator&lt;T&gt;</code> and <code>async_generator&lt;T&gt;</code>.</p>

<h3 id="future&lt;t&gt;---the-value-arrives-later"><code>future&lt;T&gt;</code> - the value arrives Later</h3>

<p>This is covered first because yield_value is composed on top of await. <code>future&lt;T&gt;</code> represents a value of T that may become available later. It may hold an exception instead. A function that returns <code>future&lt;T&gt;</code> is allowed to use <code>await</code> on an awaitable type.</p>

<h3 id="generator&lt;t&gt;---each-value-is-lazy"><code>generator&lt;T&gt;</code> - each value is Lazy</h3>

<p><code>generator&lt;T&gt;</code> implements the Range Concept so it works with existing algorithms from STL and Rangev3 and the <code>range-for</code> feature. It can be found in the header <code>experimental/generator</code>. A function that returns <code>generator&lt;T&gt;</code> is allowed to use the <code>yield_value</code> keyword (which evaluates to <code>await generator&lt;T&gt;::promise_type::yield_value(T)</code>).</p>

<h3 id="async_generator&lt;t&gt;---each-value-arrives-later"><code>async_generator&lt;T&gt;</code> - each value arrives Later</h3>

<p><code>async_generator&lt;T&gt;</code> implements a new AsyncRange Concept. <code>begin()</code> and <code>++iterator</code> return an awaitable type that produces an iterator later while <code>end()</code> returns an <code>iterator</code> immediately. A new set of algorithms is needed and a new <code>async-range-for</code> has been added that inserts <code>await</code> into <code>i = await begin()</code> and <code>await ++i</code>. A function that returns  <code>async_generator&lt;T&gt;</code> is allowed to use <code>await</code> and <code>yield_value</code>.</p>

<h3 id="resources">Resources</h3>

<ul>
<li><a href="https://twitter.com/gornishanov">Gor Nishanov </a> kindly answered many emails as I worked on the code. His epic presentation (<a href="https://github.com/CppCon/CppCon2014/blob/master/Presentations/await%202.0%20-%20Stackless%20Resumable%20Functions/await%202.0%20-%20Stackless%20Resumable%20Functions%20-%20Gor%20Nishanov%20-%20CppCon%202014.pdf">PDF</a>, <a href="https://www.youtube.com/watch?v=KUhSjfSbINE">YouTube</a>) of the design, implementation and sample usage at <a href="http://cppcon.org/">CPPCON 2014</a> is required watching.</li>
<li><a href="https://www.visualstudio.com/en-us/news/vs2015-vs.aspx">Visual Studio 2015 Preview</a> implements the await proposal (in these articles I am using CTP6).</li>
<li><a href="http://blogs.msdn.com/b/vcblog/archive/2014/11/12/resumable-functions-in-c.aspx">Visual Studio Team Blog Post</a> introducing the await implementation.</li>
<li><a href="https://paoloseverini.wordpress.com/2015/03/06/stackless-coroutines-with-vs2015/">Paolo Severini</a>  another nice introduction to await.</li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Fictional Memory</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Fictional Memory</li>
          <li><a href="mailto:kirk.shoop@gmail.com">kirk.shoop@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kirkshoop">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">kirkshoop</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/kirkshoop">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">kirkshoop</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">an intersection of C++ and Win32
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
