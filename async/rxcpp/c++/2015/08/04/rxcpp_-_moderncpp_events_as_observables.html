<!DOCTYPE html>
<html>

  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>rxcpp - moderncpp events as observables</title>
    <meta name="description" content="an intersection of C++ and Win32
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://kirkshoop.github.io/async/rxcpp/c++/2015/08/04/rxcpp_-_moderncpp_events_as_observables.html">

    <script>
      ((window.gitter = {}).chat = {}).options = {
        room: 'kirkshoop/kirkshoop.github.io'
      };
    </script>
    <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60804833-1', 'auto');
  ga('send', 'pageview');

</script>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="site-title">
      <img src="//www.gravatar.com/avatar/346d7c46fffb46511dfea6faa3e51937?s=48">
      <a href="/">Fictional Memory</a>
    </div>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewbox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">rxcpp - moderncpp events as observables</h1>
    <p class="post-meta">Aug 4, 2015</p>
  </header>

  <article class="post-content">
    <p>Kenny Kerr (<a href="http://kennykerr.ca/">blog</a>, <a href="https://twitter.com/kennykerr">twitter</a>) has released the excellent <a href="http://moderncpp.com/">moderncpp</a> library. I wanted to apply rxcpp to handle async in moderncpp. rxcpp is cross-platform and can be applied to any UI event model and I hope to build examples for other c++ UI and Networking libraries as well.</p>

<blockquote>
  <p>I would love to showcase rxcpp usage - so please let me know if you have published code that combines rxcpp with other libraries, especially UI and Networking.</p>
</blockquote>

<p>#moderncpp</p>

<p>The moderncpp library is a complete C++ SDK for the Windows Modern API (WinRT). The moderncpp library is generated from from the winmd files shipped in the windows SDK. Kenny has written about the <a href="http://moderncpp.com/2015/04/13/modern-c-as-a-better-compiler/">improved perf</a> and <a href="http://moderncpp.com/2015/04/07/a-classy-type-system-for-modern-c/">ease-of-use</a> that moderncpp provides.</p>

<p>#Sample.Composition</p>

<p>moderncpp has some sample projects. I took one of the sample projects <a href="https://github.com/kennykerr/modern/tree/master/10.0.10240.complete/Sample.Composition">Sample.Composition</a> and published it with  rxcpp usage. This sample will add a shape to the window on [Ctrl]+PointerPressed and existing shapes can be dragged around and will shift to the top of the z-order when moved.</p>

<p><img src="/assets/modern.sample.composition.png" alt="screenshot of Sample.Composition"></p>

<p>The rxcpp changes; removed state for the selected object and visuals collection from the View class, built an expression to add shapes and an expression to move shapes and made the AddVisual and SelectVisual members static.</p>

<h2 id="integration">integration</h2>

<p>The first step was to add the <a href="http://www.nuget.org/packages/rxcpp/">rxcpp nuget package</a> to the Sample.Composition project.</p>

<p>After that a header <code class="highlighter-rouge">rx.modern.h</code> was added to hold the adaptors that are needed to use rxcpp with moderncpp.</p>

<p>###Rx namespace</p>

<p><code class="highlighter-rouge">rx.modern.h</code> adds the Rx namespace that includes the major rxcpp namespaces.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="cp">#pragma once 
</span>
<span class="cp">#include &lt;rx.hpp&gt;
</span><span class="k">namespace</span> <span class="n">Rx</span> <span class="p">{</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="p">;</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="o">::</span><span class="n">sources</span><span class="p">;</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="o">::</span><span class="n">operators</span><span class="p">;</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="o">::</span><span class="n">subjects</span><span class="p">;</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="o">::</span><span class="n">util</span><span class="p">;</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">rxcpp</span><span class="o">::</span><span class="n">schedulers</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This allows all the components of rxcpp to be introduced with the svelt <code class="highlighter-rouge">Rx::</code></p>

<p>###Rx::from_event</p>

<p><code class="highlighter-rouge">rx.modern.h</code> also contains the <code class="highlighter-rouge">from_event()</code> adaptor function that is used to turn moderncpp events into <code class="highlighter-rouge">Rx::observable&lt;Event&gt;</code>.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="k">namespace</span> <span class="n">Rx</span> <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Event</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Add</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Remove</span><span class="o">&gt;</span>
    <span class="k">auto</span> <span class="n">from_event</span><span class="p">(</span><span class="n">Add</span><span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="n">Remove</span><span class="o">&amp;&amp;</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">subscriber</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">auto</span> <span class="n">token</span> <span class="o">=</span> <span class="n">a</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">Event</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">out</span><span class="p">.</span><span class="n">on_next</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="n">out</span><span class="p">.</span><span class="n">add</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span><span class="n">r</span><span class="p">(</span><span class="n">token</span><span class="p">);</span> <span class="p">});</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">publish</span><span class="p">()</span>
            <span class="p">.</span><span class="n">ref_count</span><span class="p">()</span>
            <span class="p">.</span><span class="n">as_dynamic</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">from_event()</code> is very simple. It uses <code class="highlighter-rouge">Rx::create</code> to call the supplied add function passing in a function that will call on_next for every event. It also calls the supplied remove function when <code class="highlighter-rouge">unsubscribe()</code> is called.</p>

<p><code class="highlighter-rouge">publish()</code> and <code class="highlighter-rouge">ref_count()</code> are added to share the same event handler with all the observers subscribed.</p>

<p><code class="highlighter-rouge">as_dynamic()</code> forgets the type of the stream (create, publish and ref_count) and returns the simple <code class="highlighter-rouge">Rx::observable&lt;Event&gt;</code></p>

<p>###Example</p>

<p>The usage is simple if repetitive..</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="k">auto</span> <span class="n">pressed</span> <span class="o">=</span> <span class="n">Rx</span><span class="o">::</span><span class="n">from_event</span><span class="o">&lt;</span><span class="n">PointerEventArgs</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">auto</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">window</span><span class="p">.</span><span class="n">PointerPressed</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">auto</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">window</span><span class="p">.</span><span class="n">PointerPressed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre>
</div>

<p>However, the future may include builds of moderncpp that have overloads for each event that would result in this simplified usage.</p>

<pre><code class="language-`cpp">auto pressed = window.PointerPressed();
</code></pre>

<p>##Sample.Composition’s App.cpp</p>

<p>The modified sample starts out the same way with includes and namespace references</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="cp">#include "pch.h"
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Modern</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">Foundation</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">Foundation</span><span class="o">::</span><span class="n">Numerics</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">System</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Composition</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">float</span> <span class="k">const</span> <span class="n">BlockSize</span> <span class="o">=</span> <span class="mf">100.0</span><span class="n">f</span><span class="p">;</span>

<span class="n">Point</span> <span class="nf">PositionOf</span><span class="p">(</span><span class="n">PointerEventArgs</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">CurrentPoint</span><span class="p">().</span><span class="n">Position</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">PositionOf()</code> helper was added since it is needed more than once.</p>

<h3 id="view-struct">View struct</h3>

<p>There is only one member in the View struct after removing the three members that carried state in the original sample.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="k">struct</span> <span class="n">View</span> <span class="o">:</span> <span class="n">IFrameworkViewT</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="n">CompositionTarget</span> <span class="n">m_target</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">SetWindow</span><span class="p">(</span><span class="n">CoreWindow</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">window</span><span class="p">);</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="n">AddVisual</span><span class="p">(</span><span class="n">VisualCollection</span><span class="o">&amp;</span> <span class="n">visuals</span><span class="p">,</span> <span class="n">Point</span> <span class="n">point</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">Visual</span> <span class="n">SelectVisual</span><span class="p">(</span><span class="n">VisualCollection</span><span class="o">&amp;</span> <span class="n">visuals</span><span class="p">,</span> <span class="n">Point</span> <span class="n">point</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>###AddVisual and SelectVisual</p>

<p>These were trivial changes that replaced the <code class="highlighter-rouge">this-&gt;m_visuals</code> usage with a visuals parameter and had SelectVisual return the selected Visual instead of setting <code class="highlighter-rouge">this-&gt;m_selected</code></p>

<p>Once these edits were finished the functions were made static.</p>

<p>###SetWindow member</p>

<p>All the rxcpp usage is in <code class="highlighter-rouge">SetWindow()</code> the intro is similar, but does not mention <code class="highlighter-rouge">this-&gt;m_visuals</code>.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code><span class="kt">void</span> <span class="nf">SetWindow</span><span class="p">(</span><span class="n">CoreWindow</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Compositor</span> <span class="n">compositor</span><span class="p">;</span>
    <span class="n">ContainerVisual</span> <span class="n">root</span> <span class="o">=</span> <span class="n">compositor</span><span class="p">.</span><span class="n">CreateContainerVisual</span><span class="p">();</span>
    <span class="n">m_target</span> <span class="o">=</span> <span class="n">compositor</span><span class="p">.</span><span class="n">CreateTargetForCurrentView</span><span class="p">();</span>
    <span class="n">m_target</span><span class="p">.</span><span class="n">Root</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</code></pre>
</div>

<p>The events that will be used are defined with <code class="highlighter-rouge">Rx::from_event()</code></p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>    <span class="k">auto</span> <span class="n">pressed</span> <span class="o">=</span> <span class="n">Rx</span><span class="o">::</span><span class="n">from_event</span><span class="o">&lt;</span><span class="n">PointerEventArgs</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">auto</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">window</span><span class="p">.</span><span class="n">PointerPressed</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">auto</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">window</span><span class="p">.</span><span class="n">PointerPressed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="k">auto</span> <span class="n">moved</span> <span class="o">=</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span> 

    <span class="k">auto</span> <span class="n">released</span> <span class="o">=</span> <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</code></pre>
</div>

<p>visuals is defined to be an <code class="highlighter-rouge">Rx::observable&lt;VisualCollection&gt;</code> that will send the <code class="highlighter-rouge">root.Children()</code> collection to each subscriber once.</p>

<blockquote>
  <p>visuals will send the same item again every time subscribe is called, observables that behave this way are called <em>cold</em> observables.</p>
</blockquote>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>    <span class="k">auto</span> <span class="n">visuals</span> <span class="o">=</span> <span class="n">Rx</span><span class="o">::</span><span class="n">observable</span><span class="o">&lt;&gt;::</span><span class="n">from</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">Children</span><span class="p">());</span>
</code></pre>
</div>

<p>adds and selects both use the pressed event observable. adds only keeps presses while [Ctrl] is held. selects only keeps presses while [Ctrl] is released.</p>

<p>Each event is converted to just the location where the press occured using PositionOf. This turns the original <code class="highlighter-rouge">Rx::observable&lt;PointerEventArgs&gt;</code> to <code class="highlighter-rouge">Rx::observable&lt;Point&gt;</code></p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>    <span class="c1">// get the position for a press when ctrl is pressed.
</span>    <span class="k">auto</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">pressed</span>
        <span class="p">.</span><span class="n">filter</span><span class="p">([](</span><span class="n">PointerEventArgs</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">KeyModifiers</span><span class="p">()</span> <span class="o">==</span> <span class="n">VirtualKeyModifiers</span><span class="o">::</span><span class="n">Control</span><span class="p">;</span> 
        <span class="p">})</span>
        <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PositionOf</span><span class="p">);</span>

    <span class="c1">// get the position for a press when ctrl is NOT pressed.
</span>    <span class="k">auto</span> <span class="n">selects</span> <span class="o">=</span> <span class="n">pressed</span>
        <span class="p">.</span><span class="n">filter</span><span class="p">([](</span><span class="n">PointerEventArgs</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">KeyModifiers</span><span class="p">()</span> <span class="o">!=</span> <span class="n">VirtualKeyModifiers</span><span class="o">::</span><span class="n">Control</span><span class="p">;</span> 
        <span class="p">})</span>
        <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PositionOf</span><span class="p">);</span>
</code></pre>
</div>

<p>Actually adding a new visual to the collection just involves combining the adds and visuals streams and calling AddVisual.</p>

<p>The <code class="highlighter-rouge">subscribe()</code> is required, without it there is no subscription to adds or visuals so no calls to combine_latest will occur.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>    <span class="c1">// adds visuals
</span>    <span class="n">adds</span>
        <span class="p">.</span><span class="n">combine_latest</span><span class="p">(</span>
            <span class="p">[](</span><span class="n">Point</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">position</span><span class="p">,</span> <span class="n">VisualCollection</span> <span class="n">visuals</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">View</span><span class="o">::</span><span class="n">AddVisual</span><span class="p">(</span><span class="n">visuals</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">visuals</span><span class="p">.</span><span class="n">Count</span><span class="p">();</span>
            <span class="p">},</span> 
            <span class="n">visuals</span><span class="p">)</span>
        <span class="p">.</span><span class="n">subscribe</span><span class="p">();</span>
</code></pre>
</div>

<p>moving an existing visual begins the same way as adding. The adds and visuals streams are combined and SelectVisual is called. This turns the original <code class="highlighter-rouge">Rx::observable&lt;Point&gt;</code> + <code class="highlighter-rouge">Rx::observable&lt;VisualCollection&gt;</code>  to <code class="highlighter-rouge">Rx::observable&lt;std::tuple&lt;Point, Visual&gt;&gt;</code></p>

<p>A simple filter ignores any presses that did not select a Visual (the Point was not within an existing Visual).</p>

<blockquote>
  <p><code class="highlighter-rouge">Rx::apply_to()</code> returns a function object that stores the supplied lambda. The returned function object is a function that takes a single <code class="highlighter-rouge">std::tuple&lt;&gt;</code> and calls the stored lambda with each tuple member as a separate parameter. This replaces <code class="highlighter-rouge">std::get&lt;0&gt;(arg)</code> pollution with nice named function arguments.</p>
</blockquote>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>    <span class="c1">// moves selected visuals
</span>    <span class="n">selects</span>
        <span class="p">.</span><span class="n">combine_latest</span><span class="p">(</span>
            <span class="p">[](</span><span class="n">Point</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">position</span><span class="p">,</span> <span class="n">VisualCollection</span> <span class="n">visuals</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Visual</span> <span class="n">selected</span> <span class="o">=</span> <span class="n">View</span><span class="o">::</span><span class="n">SelectVisual</span><span class="p">(</span><span class="n">visuals</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">selected</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="n">visuals</span><span class="p">)</span>
        <span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Rx</span><span class="o">::</span><span class="n">apply_to</span><span class="p">([](</span><span class="n">Point</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">Visual</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">selected</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="o">!!</span><span class="n">selected</span><span class="p">;</span> <span class="p">}))</span>
</code></pre>
</div>

<p>Now comes the magic.</p>

<p>The <code class="highlighter-rouge">map()</code> will change <code class="highlighter-rouge">Rx::observable&lt;std::tuple&lt;Point, Visual&gt;&gt;</code> to <code class="highlighter-rouge">Rx::observable&lt;Rx::observable&lt;std::tuple&lt;Visual, Vector3, Point&gt;&gt;&gt;</code></p>

<p>The nested observables returned for each selected visual produce a series of moves for that visual until the pointer is released.</p>

<p>The <code class="highlighter-rouge">merge()</code> that follows will subscribe to each new nested observable. This changes <code class="highlighter-rouge">Rx::observable&lt;Rx::observable&lt;std::tuple&lt;Visual, Vector3, Point&gt;&gt;&gt;</code> to <code class="highlighter-rouge">Rx::observable&lt;std::tuple&lt;Visual, Vector3, Point&gt;&gt;</code></p>

<p>The return from <code class="highlighter-rouge">map()</code> is the nested observable. The location of every moved event is used to create a <code class="highlighter-rouge">std::tuple&lt;Visual, Vector3, Point&gt;</code>. The following <code class="highlighter-rouge">take_until()</code> will stop listing to moved and released as soon as the pointer is released. It is the subscription in the following <code class="highlighter-rouge">merge()</code> that starts listening to moved and released for the selected visual.</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>        <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">Rx</span><span class="o">::</span><span class="n">apply_to</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="n">Point</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">position</span><span class="p">,</span> <span class="n">Visual</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">selected</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
            <span class="k">return</span> <span class="n">moved</span>
                <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PositionOf</span><span class="p">)</span>
                <span class="p">.</span><span class="n">map</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="n">Point</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">position</span><span class="p">)</span> <span class="p">{</span> 
                    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">mouse_offset</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span> 
                <span class="p">})</span>
                <span class="p">.</span><span class="n">take_until</span><span class="p">(</span><span class="n">released</span><span class="p">);</span>
        <span class="p">}))</span>
        <span class="p">.</span><span class="n">merge</span><span class="p">()</span>
</code></pre>
</div>

<p>All that remains is to actually subscribe and use the output to change the position of the selected visual</p>

<div class="language-cpp highlighter-rouge">
<pre class="highlight"><code>        <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Rx</span><span class="o">::</span><span class="n">apply_to</span><span class="p">([](</span><span class="n">Visual</span> <span class="n">selected</span><span class="p">,</span> <span class="n">Vector3</span> <span class="n">offset</span><span class="p">,</span> <span class="n">Point</span> <span class="n">position</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">selected</span><span class="p">.</span><span class="n">Offset</span><span class="p">(</span><span class="n">Vector3</span>
            <span class="p">{</span>
                <span class="n">position</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">position</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">Y</span>
            <span class="p">});</span>
        <span class="p">}));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>#done</p>

<p>The moderncpp library gives a great experience for developing universal windows apps. I am so happy to see it built and released!</p>

<p>Also, rxcpp composes quite well with moderncpp and provides benefits in avoiding mutable state and just like the STL in std, rxcpp provides algorithms in the async domain that can and should be reused rather than rebuilt using raw callbacks and state.</p>

<blockquote>
  <p>Using raw callbacks + state instead of rxcpp’s <code class="highlighter-rouge">map()</code> is equivalent to using a raw loop instead of <code class="highlighter-rouge">std::transform()</code></p>
</blockquote>

<p>#more to come</p>

<p>There are a lot of additional adaptors to be built for moderncpp. <code class="highlighter-rouge">from_asyncoperation()</code>, and schedulers for CoreDispatcher and Task would allow rxcpp to be used to compose Network and background Tasks with UI.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Fictional Memory</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Fictional Memory</li>
          <li><a href="mailto:kirk.shoop@gmail.com">kirk.shoop@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kirkshoop">
              <span class="icon  icon--github">
                <svg viewbox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
                </svg>
              </span>

              <span class="username">kirkshoop</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/kirkshoop">
              <span class="icon  icon--twitter">
                <svg viewbox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path>
                </svg>
              </span>

              <span class="username">kirkshoop</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">an intersection of C++ and Win32
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
